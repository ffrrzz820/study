/*
 plugin.js

 Released under the GNU General Public License version 3 or later.
 Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 File modified by Jonathan Hall 2021-01-27 and earlier

 License: ../license.txt
 Contributing: http://www.tinymce.com/contributing
*/
"undefined"==typeof tinymce?jQuery(document).ready(function(g){"undefined"!=typeof tinymce&&hm_bbpuip_register_plugin(g)}):hm_bbpuip_register_plugin(jQuery);
function hm_bbpuip_register_plugin(g){tinymce.PluginManager.add("hm_bbpuip_image",function(b){function p(m){return function(){m(b.settings.image_list)}}function q(m){function n(c,l){var e;a={src:c,alt:l};a.alt||(a.alt="");a.title||(a.title="");""===a.width&&(a.width=null);""===a.height&&(a.height=null);a.style||(a.style=null);a={src:a.src,alt:a.alt,title:a.title,width:a.width,height:a.height,style:a.style,caption:a.caption,"class":a["class"]};b.undoManager.transact(function(){a.src?(""===a.title&&
(a.title=null),a.id="__mcenew",b.focus(),b.selection.setContent(h.createHTML("img",a)),f=h.get("__mcenew"),h.setAttrib(f,"id",null),b.editorUpload.uploadImagesAuto(),!1===a.caption&&h.is(f.parentNode,"figure.image")&&(e=f.parentNode,h.insertAfter(f,e),h.remove(e))):f&&(h.remove(f),b.focus(),b.nodeChanged())})}if("bbp_topic_content"==b.id)if("undefined"!=typeof hm_bbpuip_count_limit&&hm_bbpuip_count_limit){var d=hm_bbpuip_count_limit-hm_bbpuip_get_uploaded_image_count();if(0>=d){alert(hm_bbpuip_strings.count_limit_topic.replace("{limit}",
hm_bbpuip_count_limit));return}}else d=null;else if("undefined"!=typeof hm_bbpuip_count_limit_reply&&hm_bbpuip_count_limit_reply){if(d=hm_bbpuip_count_limit_reply-hm_bbpuip_get_uploaded_image_count(),0>=d){alert(hm_bbpuip_strings.count_limit_reply.replace("{limit}",hm_bbpuip_count_limit_reply));return}}else d=null;var a={},h=b.dom,f;g(".bbpuip_upload_dialog:first").clone().dialog({resizable:!1,width:Math.min(Math.max(g(window).width()-50,200),500),modal:!0,create:function(){},open:function(){var c=
location.href,l=c.indexOf("#");-1!=l&&(c=c.substr(0,l));c+=(-1==c.indexOf("?")?"?":"&")+"hm_bbpuip_do_upload=1";g(this).find(".bbpuip_drop_area").dropzone({url:c,paramName:"hm_bbpuip_file",createImageThumbnails:!1,previewTemplate:"<span></span>",clickable:g(this).find(".bbpuip_drop_area_container *").get(),maxFiles:d,init:function(){this.on("success",function(e,k){k=k.trim();"http"==k.substr(0,4)?(filenameDotPos=e.name.lastIndexOf("."),e=-1==filenameDotPos?e.name:e.name.substr(0,filenameDotPos),n(k,
e)):"Px_Size_Error"==k?hm_bbpuip_strings.px_size_upload_error&&hm_bbpuip_px_size_limit?alert(hm_bbpuip_strings.px_size_upload_error.replace("{limit}",hm_bbpuip_px_size_limit)):alert("Error"):hm_bbpuip_strings.upload_error&&hm_bbpuip_upload_size_limit?alert(hm_bbpuip_strings.upload_error.replace("{limit}",hm_bbpuip_upload_size_limit)):alert("Error")});this.on("error",function(e,k){"You can not upload any more files."!=k&&(hm_bbpuip_strings.upload_error&&hm_bbpuip_upload_size_limit?alert(hm_bbpuip_strings.upload_error.replace("{limit}",
hm_bbpuip_upload_size_limit)):alert("Error"))});this.on("totaluploadprogress",function(e){g(this.element).find("h3").text(hm_bbpuip_strings.uploading);g(this.element).find("p").text(Math.round(e)+hm_bbpuip_strings.percent_complete)});this.on("queuecomplete",function(){g(this.element).closest(".bbpuip_upload_dialog").dialog("destroy")});this.on("maxfilesexceeded",function(){"bbp_topic_content"==b.id?alert(hm_bbpuip_strings.count_limit_topic.replace("{limit}",hm_bbpuip_count_limit)):alert(hm_bbpuip_strings.count_limit_reply.replace("{limit}",
hm_bbpuip_count_limit_reply))})}})}})}b.on("preInit",function(){function m(d){return(d=d.attr("class"))&&/\bimage\b/.test(d)}function n(d){return function(a){function h(l){l.attr("contenteditable",d?"true":null)}for(var f=a.length,c;f--;)c=a[f],m(c)&&(c.attr("contenteditable",d?"false":null),tinymce.each(c.getAll("figcaption"),h))}}b.parser.addNodeFilter("figure",n(!0));b.serializer.addNodeFilter("figure",n(!1))});b.addButton("image",{icon:"image",tooltip:"Insert image",onclick:p(q),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"});
b.addMenuItem("image",{icon:"image",text:"Insert image",onclick:p(q),context:"insert",prependToContext:!0});b.addCommand("mceImage",p(q))})};
